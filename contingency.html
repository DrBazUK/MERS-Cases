<!DOCTYPE html>
<meta charset="utf-8">
<title>MERS-CoV Cases</title>
<link rel="stylesheet" type="text/css" href="css/dc.css"/>
<link rel="stylesheet" href="css/leaflet.css" />
<link rel="stylesheet" href="css/MarkerCluster.css" />
<link rel="stylesheet" href="css/MarkerCluster.Default.css" />
<link href="js/tooltips/themes/1/tooltip.css" rel="stylesheet" type="text/css" />

<style type="text/css">
	.label
	{
		font-family: Helvetica,Arial,sans-serif;
		font-size: 9pt;
	}
	.value
	{
		font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
		font-size: 9pt;
		color: gray;
		fill-opacity: .6;
	}

	.tick_label
	{
		font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
		font-size: 9pt;
	}
</style>

<style type="text/css">
	#table {
		background-color: whiteSmoke;
		border-radius: 6px;
		-webkit-border-radius: 6px;
		-moz-border-radius: 6px;
	}
	#table td, #table th {

	}
	#table th {
		color: #333;
		font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
		font-size: 11px;
		font-style: normal;
		font-weight: normal;
		text-align: left;
		padding: 0 20px;
	}
	#table td {
		padding: 0 20px;
		line-height: 20px;
		color: #0084B4;
		font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
		font-size: 11px;
		border-bottom: 1px solid #fff;
		border-top: 1px solid #fff;
	}
/*	
	#table td:hover {
		background-color: #fff;
	}
*/	
</style>

<div id="body">
	<div style="display: inline-block">
		<table id="table">
			<thead>
				<tr>
					<th scope="row">&nbsp;</th>
					<th scope="col"><span id="c1h">Dead</span></th>
					<th scope="col"><span id="c2h">Survived</span></th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<th scope="row"><span id="r1h">With existing conditions</span></th>
					<td><span id="r1c1">322</span></td>
					<td><span id="r2c1">43</span></td>
				</tr>
				<tr>
					<th scope="row" id="r2h"><span id="r2h">Without existing conditions</span></th>
					<td><span id="r2c1">23</span></td>
					<td><span id="r2c2">25</span></td>
				</tr>
			</tbody>
		</table>
	</div>
	<div style="display: inline-block">
		<div id="chart"></div>
	</div>
</div>

<script src="js/crossfilter.min.js"></script>
<script src="js/d3.min.js"></script>
<script src="js/dc.min.js"></script>
<script src="js/queue.min.js"></script>
<script src="js/utils.js"></script>

<script>

	queue()
		.defer(d3.csv, "data/cases.csv")
		.await(ready);

	function ready(error, caseData) {
		if (error) return console.log("there was an error loading the data: " + error);

		// Various formatters.
		var formatNumber = d3.format(",d"),
			formatDate = d3.time.format("%Y-%m-%d"),
			formatPrettyDate = d3.time.format("%d %b"),
			formatMonth = d3.time.format("%b %Y");


		var cases = [];

		// A little coercion, since the CSV is untyped.
		caseData.forEach(function(d, i) {
			d.index = i;
	
			if (d.onset != null) {
				d.onset = formatDate.parse(d.onset);
			}
	
			if (d.hospitalized != null) {
				d.hospitalized = formatDate.parse(d.hospitalized);
			}

			if (d.reported != null) {
				d.reported = formatDate.parse(d.reported);
			}

			if (d.death != null) {
				d.death = formatDate.parse(d.death);
				if (d.death != null || d.outcome === 'fatal') {
					d.outcome = 2;
				} else {
					d.outcome = 1;
				}
			} else if (d.outcome == 'fatal') {
				d.outcome = 2;
			} else {
				d.outcome = 1;
			}
	
			d.date = d.onset;
			d.dateType = "onset";

			if (d.date == null) {
				d.date = d.hospitalized;
				d.dateType = "hospitalized";
			}
			if (d.date == null) {
				d.date = d.death;
				d.dateType = "death";

				if (d.date == null || d.reported < d.date) {
					d.date = d.reported;
					d.dateType = "reported";
				}
			}

			// convert age to number (with be NaN if parsing fails).
			d.age = +d.age;
	 
			if (d.gender == 'F') {
				d.genderCode = 1;
			} else if (d.gender == 'M') {
				d.genderCode = 2;
			} else {
				d.genderCode = 0;
			}
	
			if (d.date != null) {
				cases.push(d);
			}

			d.comorbidity = (d.comorbidity === "TRUE" ? true : false);

			d.contact = (d.secondary === "TRUE" ? d.contact : "primary");
			d.contact = (d.contact === "contact" ? "unspecified contact" : d.contact);

			d.status = (d.suspected === "TRUE" ? "suspected" : "confirmed");

			var found = false;

		});
  	
		// Create the crossfilter for the relevant dimensions and groups.
		var crossFilter = crossfilter(cases),
			filteredCases = crossFilter.groupAll(),
			allCases = crossFilter.dimension(function(d) { return d; }),
			gender = crossFilter.dimension(function(d) { return d.genderCode; }),
			genders = gender.group(function(d) { return d; }),
			outcome = crossFilter.dimension(function(d) { return d.outcome }),
			outcomes = outcome.group(function(d) { return d; }),
			comorbidity = crossFilter.dimension(function(d) { return d.comorbidity }),
			age = crossFilter.dimension(function(d) { return d.age; }),
			contact = crossFilter.dimension(function(d) { return d.contact; }),
			caseStatus = crossFilter.dimension(function(d) { return d.status; });

		caseStatus.filter("confirmed");
		
		var outcomeValues = outcomes.top(2);
	 	console.log(outcomeValues);
		
		comorbidity.filter(true);

		var outcomeValues = outcomes.top(2);
	 	console.log(outcomeValues);

    var data = [{"label":"with comorbidity, dead", "value":16}, 
            	{"label":"with comorbidity, survived", "value":56}, 
            	{"label":"without comorbidity, dead", "value":7},
            	{"label":"without comorbidity, survived", "value":77}];

    //maximum of data you want to use
    var data_max = 80,

    //number of tickmarks to use
    num_ticks = 5,

    //margins
    left_margin = 160,
    right_margin = 30,
    top_margin = 30,
    bottom_margin = 0;

    var w = 300,                        //width
        h = 200,                        //height
        color = function(id) { return (id % 2 == 0 ? '#F08080' : '#ADD8E6') };

    var x = d3.scale.linear()
        	.domain([0, data_max])
        	.range([0, w - (left_margin + right_margin) ]),
        	
        y = d3.scale.ordinal()
        	.domain(d3.range(data.length))
        	.rangeRoundBands([bottom_margin, h - top_margin], 0.05, 0.455);

    var chart_top = h - y.rangeBand()/2 - top_margin;
    var chart_bottom = bottom_margin + y.rangeBand()/2;
    var chart_left = left_margin;
    var chart_right = w - right_margin;

    /*
     *  Setup the SVG element and position it
     */
    var vis = d3.select("#chart")
        .append("svg:svg")
            .attr("width", w)
            .attr("height", h)
        .append("svg:g")
            .attr("id", "barchart")
            .attr("class", "barchart")

    //Ticks
    var rules = vis.selectAll("g.rule")
        .data(x.ticks(num_ticks))
    	.enter()
        .append("svg:g")
        .attr("transform", function(d) {
                return "translate(" + (chart_left + x(d)) + ")";
            });
            
    rules.append("svg:line")
        .attr("class", "tick")
        .attr("y1", chart_top)
        .attr("y2", chart_top + 4)
        .attr("stroke", "black");

    rules.append("svg:text")
        .attr("class", "tick_label")
        .attr("text-anchor", "middle")
        .attr("y", chart_top)
        .text(function(d) {
        	return d;
        });
        
    var bbox = vis.selectAll(".tick_label").node().getBBox();
    
    vis.selectAll(".tick_label")
    	.attr("transform", function(d) {
            return "translate(0," + (bbox.height) + ")";
        });

    var bars = vis.selectAll("g.bar")
        .data(data)
   		.enter()
        .append("svg:g")
            .attr("class", "bar")
            .attr("transform", function(d, i) { 
                    return "translate(" + chart_left + ", " + y(i) + ")"; 
                });

    bars.append("svg:rect")
        .attr("x", 0)
        .attr("width", function(d) {
                return (x(d.value));
            })
        .attr("height", y.rangeBand())
        .attr("fill", function(d, i) {
                return (color(i));
            })
        .attr("stroke", function(d, i) {
                return (color(i));
            });

    //Labels
    var labels = vis.selectAll("g.bar")
        .append("svg:text")
            .attr("class", "label")
            .attr("x", 0)
            .attr("text-anchor", "right")
            .text(function(d) {
                    return d.label;
                });

    var bbox = labels.node().getBBox();
    vis.selectAll(".label")
        .attr("transform", function(d) {
                return "translate(" + (-chart_left) + ", " + (y.rangeBand()/2 + bbox.height/4) + ")";
            });


    labels = vis.selectAll("g.bar")
        .append("svg:text")
        .attr("class", "value")
        .attr("x", function(d) {
                return x(d.value) + 4;
            })
        .attr("text-anchor", "left")
        .text(function(d) {
       		return "" + d.value + "%";
        });

    bbox = labels.node().getBBox();
    vis.selectAll(".value")
        .attr("transform", function(d)
        {
            return "translate(0, " + (y.rangeBand()/2 + bbox.height/4) + ")";
        });

    //Axes
    vis.append("svg:line")
        .attr("class", "axes")
        .attr("x1", chart_left)
        .attr("x2", chart_left)
        .attr("y1", chart_bottom)
        .attr("y2", chart_top)
        .attr("stroke", "black");
     vis.append("svg:line")
        .attr("class", "axes")
        .attr("x1", chart_left)
        .attr("x2", chart_right)
        .attr("y1", chart_top)
        .attr("y2", chart_top)
        .attr("stroke", "black");
 
	} // function ready(error, caseData)

</script>
